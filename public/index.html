<!DOCTYPE html>
<html>
<head>
    <title>Question Answer System Study</title>
    <style>
        .hidden {
            display: none;
        }
        .document {
            display: block; /* Always display documents */
            margin-left: 20px;
        }
        .document-id {
            color: blue;
            text-decoration: underline;
        }
        .citation {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
        .tooltip-container {
            display: none;
            position: relative;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            z-index: 1000;
            max-width: 1000px;
            white-space: pre-wrap;
            cursor: text;
            user-select: text;
            margin-top: 10px;
        }
        .highlight {
            background-color: yellow; /* Highlight background color */
            padding: 0 2px;           /* Optional padding for better appearance */
        }
        #navigation {
            margin-top: 20px;
        }
        textarea {
            width: 100%;
            height: 
            100px;
        }

    </style>
</head>
<body>

    <div id="nameContent" >
        <h1>Welcome to the Question-Answering Annotation Study</h1>
        <p>Please enter your name and we'll introduce you to your task:</p>
        <form>
            <input type="text" id="userName" name="userName" value="Your name">
            <button type="button" onclick="saveName()">Next</button>
        </form>
    
    </div>

    <div id="introContent" class="hidden">
        <h1>Welcome to the Question-Answering Annotation Study</h1>
        <p>For this study, you will be revising answers generated by our automated question-answering system. Our system answers questions using only relevant sections of documents sourced from our database and provides citations using them. Your revisions should ensure that the answer is correct according to the retrieved documents.</p>
        <p>You may not use the web or large language models to revise the answers. Some of the documents are intentionally fabricated, so you will not be able to correctly revise the question by searching online. </p>
        <p>Here is an example of system response that requires revision. Click the citations to view retrieved content snippets that are relevant to the question. </p>
        <p><b>Question</b>: Who has been in more musical groups, Cedric Bixler-Zavala or Coko?</p>
        <div id="exampleAnswer"></div>
        <p> In this example, the system-generated answer is incorrect. It claims that Coko has been in was in musical groups not mentioned in the cited documents. Becuase the system cannot support its claim with the provided citations, it cannot say that Coko was in four musical groups. 
        </p>
        <p> Here is a properly revised answer given the source documents:</p>
        <p><b>Revised Answer</b>: Cedric Bixler-Zavala has been a member of four musical groups: The Mars Volta, At the Drive-In, Antemasque, and Zavalaz [1]. Meanwhile, Coko has been part of two musical projects: the R&B trio Sisters With Voices (SWV) and a solo gospel career [2]. Therefore, Cedric Bixler-Zavala has been in more musical groups than Coko.
        <p>Your answers should be at least 1 - 2 sentences long to provide explanations backed by cited content. You may choose to use all or none of the system's response for your final answers, so long as the response to the query is correct, according to the retrieved documents, and additional context in the response matches the information provided in the given citations. </p>
        <button onclick="startQuiz()">Next</button>
        
    </div>

    <div id="quizContent" class="hidden">
        <div> 
            <p> <b>Revise, if necessary, the system-generated answer to the question to ensure that it is correct based on the cited sources. Use only the citations provided. Answers should be at least 1 - 2 sentences long to provide explanations backed by citations. You may chose to use all or none of the system's response for your final answers, so long as the response to the query is correct and additional context in the response matches the information provided in the given citations. Hover over the citations to view retrieved content snippets that are relevant to the question. Your edited answers will be saved as you navigate between questions.</b></p>
        </div>
        <div id="jsonContent"></div>
        <div id="questionCounter"></div>
        <div id="navigation">
            <button id="nextButton" onclick="nextQuestion()">Next</button>
        </div>
        <button id="endButton" style="display: none;" onclick="endQuiz()">Finish and Save</button>
    </div>

    <div id="thankYouContent" class="hidden">
        <h1>Thank You!</h1>
        <p>Thank you for completing the quiz. Your answers have been saved. We appreciate your time and effort.</p>
    </div>


    <script>
        let currentIndex = 0;
        let questions = [];
        let startTime = null;
        let userName = "";
        const exampleAnswer = "Cedric Bixler-Zavala has been in three musical groups: The Mars Volta, At the Drive-In, and Antemasque [1]. On the other hand, Coko has been in four musical groups: Sisters With Voices (SWV), God's Property, the collaborative project Make It Last Forever, and the jazz ensemble Three Ladies [2]. Therefore, Coko has been in more musical groups than Cedric Bixler-Zavala.";
        const exampleDocuments = {
            "[1]":"Cedric Bixler-Zavala (born November 4, 1974) is an American singer and songwriter. He is the lead singer and lyricist of the progressive rock band The Mars Volta and the only constant member of the post-hardcore group At the Drive-In, for which he is the lead singer and occasional guitarist. He is also the lead singer of the band Antemasque, and sings and plays guitar in his band Zavalaz.",
            "[2]":"Cheryl Elizabeth Gamble (formerly Clemons; born June 13, 1970), better known by her stage name Coko, is an American R&B recording artist and television personality. Gamble is best known as the lead singer of the American R&B vocal trio Sisters With Voices (SWV). Aside from her R&B career, Gamble also has a solo gospel career."
        }
        const exampleIndex = 10000;
        let exampleContent = `<p><b>System Answer: </b><span id="answer-${exampleIndex}">${formatAnswerWithCitations(exampleAnswer, exampleDocuments,exampleIndex)}</span></p>`;
        exampleContent += `<div id="tooltipContainer-${exampleIndex}" class="tooltip-container"></div>`;

        document.getElementById('exampleAnswer').innerHTML = exampleContent;

        document.addEventListener('DOMContentLoaded', function() {
            fetch('quiz_web.json')
                .then(response => response.json())
                .then(data => {
                    questions = data.map(q => {
                        let documentClicks = {};
                        for (let key in q.documents) {
                            documentClicks[key] = 0;
                        }
                        return { ...q, userAnswer: q.userAnswer || q.answer, timeSpent: 0, documentClicks };
                    });
                    restoreState();
                })
                .catch(error => console.error('Error loading JSON:', error));
        });

        function saveName() {
            document.getElementById('nameContent').classList.add('hidden');
            document.getElementById('introContent').classList.remove('hidden');
            userName = document.getElementById('userName').value;

        }
        function startQuiz() {
            document.getElementById('introContent').classList.add('hidden');
            document.getElementById('quizContent').classList.remove('hidden');
            saveState();
            displayQuestion(currentIndex);
            updateQuestionCounter(currentIndex+1);
        }

        function displayQuestion(index) {
            if (startTime !== null) {
                saveTimeSpent(currentIndex);
            }
            const jsonContentDiv = document.getElementById('jsonContent');
            if (questions[index]) {
                let item = questions[index];
                let displayText = `<p><b>Question:</b> ${item.question}<br>`;
                    displayText += `<b>System Answer:</b> <span id="answer-${index}">${formatAnswerWithCitations(item.answer, item.documents, index)}</span></p>`;
                displayText += `<div id="tooltipContainer-${index}" class="tooltip-container"></div>`;
                displayText += `<b>Your Revision</b><br>`;
                displayText += `<textarea id="userAnswer-${index}">${item.userAnswer}</textarea><br></p>`;
                displayText += `<br></p>`;
                jsonContentDiv.innerHTML = displayText;

                document.getElementById('nextButton').style.display = index === questions.length - 1? 'none' : 'block';
                document.getElementById('endButton').style.display = index === questions.length - 1 ? 'block' : 'none';

                startTime = new Date();
                currentIndex = index;
                saveState();
            }
        }

        function formatAnswerWithCitations(answer, documents, index) {
            return answer.replace(/\[(\d+)\]/g, function(match, number) {
                let doc = documents[`[${number}]`];
                // Replace special characters with HTML entities
                doc = doc.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                return `<span class="citation" onclick="toggleTooltip('${encodeURIComponent(doc)}', ${number}, ${index})">${match}</span>`;
            });
        }

        function toggleTooltip(encodedText, number, index) {
            const tooltipContainer = document.getElementById(`tooltipContainer-${index}`);
            const text = decodeURIComponent(encodedText); // Decode URI component
            const fullText = `[${number}] ${text}`;
            let displayText = ""

            if (toString(tooltipContainer.innerHTML) === toString(displayText) && tooltipContainer.style.display === 'block') {
                tooltipContainer.style.display = 'none';
                displayText = "";
            } else {
                tooltipContainer.innerHTML = fullText;
                displayText = tooltipContainer.innerHTML;
                tooltipContainer.style.display = 'block';
                if (index !== exampleIndex) {
                    incrementDocumentClickCount(index, `[${number}]`);
                }
            }
        }

        function incrementDocumentClickCount(index, docKey) {
            if (questions[index].documentClicks[docKey] !== undefined) {
                questions[index].documentClicks[docKey]++;
            }
        }

        function saveTimeSpent(index) {
            const endTime = new Date();
            const timeSpent = (endTime - startTime) / 1000; // time in seconds
            questions[index].timeSpent += timeSpent;
        }

        function saveUserAnswer(index) {
            const userAnswerTextarea = document.getElementById(`userAnswer-${index}`);
            if (userAnswerTextarea) {
                questions[index].userAnswer = userAnswerTextarea.value;
            }
        }

        function nextQuestion() {
            saveTimeSpent(currentIndex);
            saveUserAnswer(currentIndex);
            if (currentIndex < questions.length - 1) {
                displayQuestion(currentIndex + 1);
                updateQuestionCounter();

            } 
        }

        function endQuiz() {
            document.getElementById('quizContent').classList.add('hidden');
            document.getElementById('thankYouContent').classList.remove('hidden');
            saveAnswers();
        }

        function updateQuestionCounter() {
            const counterElement = document.getElementById('questionCounter');
            counterElement.innerText = `Question ${currentIndex + 1} of ${questions.length}`;
        }

        function saveAnswers() {
            saveTimeSpent(currentIndex); // Save the current answer before sending data
            saveUserAnswer(currentIndex);
            console.log('username:', userName);
            const answersToSave = questions.map(q => ({
                id: q.id,
                userAnswer: q.userAnswer,
                timeSpent: q.timeSpent,
                documentClicks: q.documentClicks
            }));
            const dataToSend = {
                userName: userName, // Include the username in the data
                answers: answersToSave
            };

            fetch('/save-answers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.text())
            .then(result => alert(result))
            .catch(error => console.error('Error saving answers:', error));
        }
        function saveState() {
            localStorage.setItem('userName', userName);
            localStorage.setItem('currentIndex', currentIndex);
            localStorage.setItem('questions', JSON.stringify(questions));
        }

        function restoreState() {
            const savedIndex = localStorage.getItem('currentIndex');
            const savedQuestions = localStorage.getItem('questions');
            const savedUserName = localStorage.getItem('userName');


            if (savedIndex !== null && savedQuestions !== null && savedUserName !== null) {
                currentIndex = parseInt(savedIndex, 10);
                userName = savedUserName;
                questions = JSON.parse(savedQuestions);

                document.getElementById('introContent').classList.add('hidden');
                document.getElementById('quizContent').classList.remove('hidden');
                displayQuestion(currentIndex);
                updateQuestionCounter();
            }
        }
    </script>
</body>
</html>
